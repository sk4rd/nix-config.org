#+title: Sk4rd's NixOS Config in Org-Mode
#+property: header-args :mkdirp yes :comments link :results silent

[[./colors.png]]

This is my NixOS and HomeManager configuration using flakes, which is
written in Emacs' org-mode. It is an attempt to better structure my
config and create a place to edit and maintain configs for other
programs declaratively.

* Flake

This is the flake for managing inputs to my NixOS and HomeManager
config. The configs are defined as flake outputs.

#+begin_src nix :tangle flake.nix
  {
    description = "Sk4rd's NixOS & HomeManager Config";

    inputs = {
      nixpkgs.url = "github:NixOS/nixpkgs/nixos-24.11";
      home-manager.url = "github:nix-community/home-manager/release-24.11";
      home-manager.inputs.nixpkgs.follows = "nixpkgs";
      nixos-hardware.url = "github:NixOS/nixos-hardware";
      agenix.url = "github:ryantm/agenix";
    };

    outputs =
      { self, ... }@inputs:
      let
        system = "x86_64-linux";
        pkgs = import inputs.nixpkgs {
          inherit system;
          config.allowUnfree = true;
        };

        mkHostConfig =
          {
            extraModules ? [ ],
          }:
          host:
          inputs.nixpkgs.lib.nixosSystem {
            inherit pkgs;
            modules = [ ./hosts/${host} ] ++ extraModules;
          };

        mkNixosConfigs =
          configs:
          inputs.nixpkgs.lib.genAttrs (builtins.attrNames configs) (
            name: mkHostConfig { extraModules = configs.${name}.extraModules or [ ]; } name
          );

        mkHomeConfig =
          {
            extraModules ? [ ],
          }:
          user: host:
          inputs.home-manager.lib.homeManagerConfiguration {
            inherit pkgs;
            modules = [ ./home/${user}/${host} ] ++ extraModules;
          };

        mkHomeManagerConfigs =
          configs:
          inputs.nixpkgs.lib.genAttrs (builtins.attrNames configs) (
            name:
            let
              parts = builtins.split "@" name;
              user = builtins.elemAt parts 0;
              host = builtins.elemAt parts 2;
            in
            mkHomeConfig {
              extraModules = configs.${name}.extraModules or [ ];
            } user host
          );
      in
      {
        nixosConfigurations = mkNixosConfigs {
          "laptop".extraModules = [ inputs.nixos-hardware.nixosModules.lenovo-thinkpad-z13-gen1 ];
          "desktop".extraModules = [
            inputs.nixos-hardware.nixosModules.common-cpu-amd
            inputs.nixos-hardware.nixosModules.common-gpu-amd
            inputs.nixos-hardware.nixosModules.common-pc-ssd
          ];
        };

        homeConfigurations = mkHomeManagerConfigs {
          "miko@laptop" = { };
          "miko@desktop" = { };
        };
      };
  }
#+end_src

* NixOS

** Common Configuration

*** Generic

This contains the generic system configuration, such as time zone and
fonts.

#+begin_src nix :tangle hosts/common/generic.nix
  { pkgs, ... }:

  {
    # Set the time zone
    time.timeZone = "Europe/Berlin";

    # Enable experimental nix features
    nix.settings.experimental-features = [
      "nix-command"
      "flakes"
    ];

    # Change font settings
    fonts = {
      enableDefaultPackages = true;
      packages = with pkgs; [
        (nerdfonts.override { fonts = [ "Iosevka" ]; })
      ];
      fontconfig = {
        enable = true;
        useEmbeddedBitmaps = true;
      };
      fontDir.enable = true;
    };

    # Do not change this after building your system
    system.stateVersion = "24.11";
  }
#+end_src

*** Bootloader

This enables and configures the systemd-boot loader.

#+begin_src nix :tangle hosts/common/boot.nix
  { ... }:

  {
    boot.loader = {
      efi.canTouchEfiVariables = true;
      systemd-boot = {
        enable = true;
        editor = false;
        configurationLimit = 30;
      };
    };
  }
#+end_src

*** Users

This defines the user configuration, including user groups and default
shell.

#+begin_src nix :tangle hosts/common/users.nix
  { config, pkgs, ... }:

  let
    username = "miko"; # Change this value to your own
    description = "Mikolaj Bajtkiewicz"; # Usually set to your name
  in
  {
    users.defaultUserShell = pkgs.zsh;
    users.users.${username} = {
      inherit description;
      isNormalUser = true;
      useDefaultShell = true;
      extraGroups = [
        "wheel"
        "dialout"
        (if config.networking.networkmanager.enable then "networkmanager" else "")
        (if config.virtualisation.docker.enable then "docker" else "")
      ];
    };
  }
#+end_src

*** Shell

#+begin_src nix :tangle hosts/common/shell.nix
  { ... }:

  {
    programs.zsh = {
      enable = true;
      enableCompletion = true;
      autosuggestions.enable = true;
      syntaxHighlighting.enable = true;
      ohMyZsh = {
        enable = true;
        theme = "candy";
        plugins = [
          "sudo"
          "git"
          "zsh-bat"
        ];
      };
    };
  }
#+end_src

*** AMDGPU

This section enables opencl and vulkan on amd gpus.

#+begin_src nix :tangle hosts/common/amdgpu.nix
  { ... }:

  {
    hardware.amdgpu = {
      opencl.enable = true;
      amdvlk.enable = true;
      amdvlk.support32Bit.enable = true;
    };
  }
#+end_src

*** Networking

This is the networking setup.

#+begin_src nix :tangle hosts/common/networking.nix
  { ... }:

  {
    networking.networkmanager.enable = true;
    networking.wireguard.enable = true;
    networking.firewall.enable = true;
  }
#+end_src

*** Bluetooth

#+begin_src nix :tangle hosts/common/bluetooth.nix
  { ... }:

  {
    hardware.bluetooth = {
      enable = true;
      powerOnBoot = true;
      settings.General = {
        ControllerMode = "dual";
        FastConnectable = true;
        Experimental = true;
      };
    };
  }
#+end_src

*** Virtualisation

This configures virtualisation options like Docker and libvirtd.

#+begin_src nix :tangle hosts/common/virtualisation.nix
  { pkgs, ... }:

  {
    virtualisation = {
      libvirtd = {
        enable = true;
        qemu.ovmf = {
          enable = true;
          packages = with pkgs; [ OVMFFull.fd ];
        };
        qemu.swtpm.enable = true;
      };
      spiceUSBRedirection.enable = true;
      docker.enable = true;
    };
  }
#+end_src
*** Controllers

#+begin_src nix :tangle hosts/common/controllers.nix
  { ... }:

  {
    # XBOX Controller
    hardware.xone.enable = true;
    # Steam Controller
    hardware.steam-hardware.enable = true;
  }
#+end_src

*** Hyprland Desktop Environment

#+begin_src nix :tangle hosts/common/hyprland.nix
  { pkgs, ... }:

  {
    programs.hyprland.enable = true;
    programs.hyprlock.enable = true;

    services.gvfs.enable = true;
    services.udisks2.enable = true;
    services.greetd = {
      enable = true;
      settings = {
        default_session = {
          command = "${pkgs.greetd.tuigreet}/bin/tuigreet -tr --cmd '${pkgs.hyprland}/bin/Hyprland'";
          user = "greeter";
        };
      };
    };
    services.pipewire = {
      enable = true;
      alsa.enable = true;
      alsa.support32Bit = true;
      pulse.enable = true;
      jack.enable = true;
      wireplumber.enable = true;
      extraConfig.pipewire."10-clock-rate" = {
        "context.properties" = {
          "default.clock.rate" = 192000;
          "default.clock.allowed.rates" = [
            192000
            96000
            48000
            44100
          ];
        };
      };
    };
  }
#+end_src

*** Printing

#+begin_src nix :tangle hosts/common/printing.nix
  { pkgs, ... }:

  {
    # Cupsd configuration for printing
    services.printing = {
      enable = true;
      drivers = with pkgs; [ postscript-lexmark ];
    };
  }
#+end_src

** Laptop

This is my laptop specific configuration.

#+begin_src nix :tangle hosts/laptop/default.nix
  { ... }:

  {
    imports = [
      ../common/generic.nix
      ../common/boot.nix
      ../common/users.nix
      ../common/shell.nix
      ../common/amdgpu.nix
      ../common/networking.nix
      ../common/bluetooth.nix
      ../common/virtualisation.nix
      ../common/controllers.nix
      ../common/hyprland.nix
      ../common/printing.nix

      ./kernelModules.nix
      ./filesystem.nix
    ];
  }
#+end_src

*** Filesystem

This configures the file systems for the laptop, including boot and
root.

#+begin_src nix :tangle hosts/laptop/filesystems.nix
  { ... }:

  {
    # File system config
    fileSystems."/" = {
      device = "/dev/disk/by-uuid/bc1d0786-cf98-4955-b442-18076c604f58"; # Change this...
      fsType = "ext4";
    };

    fileSystems."/boot" = {
      device = "/dev/disk/by-uuid/4AB9-DD8D"; # ... and this value according to your disks
      fsType = "vfat";
      options = [
        "fmask=0077"
        "dmask=0077"
      ];
    };

    boot.supportedFilesystems = [ "ntfs" ];
  }
#+end_src

*** Kernel Modules

This includes kernel modules needed for specific hardware support.

#+begin_src nix :tangle hosts/laptop/kernelModules.nix

  { ... }:

  {
    boot.kernelModules = [ "kvm-amd" ];
    boot.initrd.availableKernelModules = [
      "nvme"
      "xhci_pci"
      "thunderbolt"
      "usb_storage"
      "sd_mod"
    ];
  }
#+end_src

** Desktop

This is my desktop specific configuration.

#+begin_src nix :tangle hosts/desktop/default.nix
  { ... }:

  {
    imports = [
      ../common/generic.nix
      ../common/boot.nix
      ../common/users.nix
      ../common/shell.nix
      ../common/amdgpu.nix
      ../common/networking.nix
      ../common/virtualisation.nix
      ../common/controllers.nix
      ../common/hyprland.nix
      ../common/printing.nix

      ./filesystem.nix
    ];
  }
#+end_src

*** Filesystem

#+begin_src nix :tangle hosts/desktop/filesystem.nix
  { ... }:

  {
    fileSystems."/" = {
      device = "/dev/disk/by-uuid/776417cb-937b-45bc-b6e0-026615e9da40";
      fsType = "ext4";
    };

    fileSystems."/boot" = {
      device = "/dev/disk/by-uuid/C4FA-A3EF";
      fsType = "vfat";
    };

    swapDevices = [
      {
        device = "/.swapfile";
        size = 32 * 1024;
      }
    ];
  }
#+end_src

* HomeManager

** Common

#+begin_src nix :tangle home/common/default.nix
  {... }:

  {
    imports = [
      # Programs
      ./emacs.nix
      ./kitty.nix
    ];
  }
#+end_src

** Programs

*** Emacs

This is my init.el, which gets tangled directly into the =extraConfig=
option of my nix config.

**** Backup & Autosave Behavior

This changes the backup and autosave directories, so no annoying files
pop up in my projects.

#+name: backup-and-autosave
#+begin_src elisp
  ;; Backup directory in ~/.emacs.d/backups
  (let ((backup-dir "~/.emacs.d/backups"))
    (unless (file-exists-p backup-dir)
      (make-directory backup-dir))
    (setq backup-directory-alist `(("." . ,backup-dir))))

  ;; Autosave directory in ~/.emacs.d/autosaves
  (let ((autosave-dir "~/.emacs.d/autosaves"))
    (unless (file-exists-p autosave-dir)
      (make-directory autosave-dir))
    (setq auto-save-file-name-transforms
          `((".*" ,(concat autosave-dir "/\\1") t))))
#+end_src

**** Look & Feel

This sets the catpuccin theme, sets a font and then disables all gui
elements.

#+name: look-and-feel
#+begin_src elisp
  ;; Apply catppuccin theme
  (setq catppuccin-flavor 'mocha)
  (load-theme 'catppuccin t)

  ;; Set IBM Plex Mono font
  (set-frame-font "BlexMono Nerd Font 10" nil t)

  ;; Disable GUI elements
  (menu-bar-mode -1)
  (scroll-bar-mode -1)
  (tool-bar-mode -1)
#+end_src

**** Tab Behavior

This sets the indenting mode to spaces instead of tabs and gives the
tabs a width of 4.

#+name: tab-behavior
#+begin_src elisp
  ;; Use spaces instead of tabs globally
  (setq-default indent-tabs-mode nil)

  ;; Set the default tab width to 4 spaces (optional, adjust as needed)
  (setq-default tab-width 4)
#+end_src

**** Code Editing

This section sets up emacs as a lightweight IDE with autocompletion.

#+name: code-editing
#+begin_src elisp
  ;; Set up modes for files
  (with-eval-after-load 'auto-mode-alist
    (add-to-list 'auto-mode-alist '("\\.nix\\'" . nix-mode)))

  ;; Set up auto completion with company-mode
  (autoload 'company "company-mode" "Company mode for text completion." t)
  (with-eval-after-load 'company
    (setq company-idle-delay 0.1)
    (setq company-minimum-prefix-length 2)
    (setq company-tooltip-align-annotations t)
    (add-to-list 'company-backends 'company-capf))
  (add-hook 'prog-mode-hook 'company-mode)

  ;; Set up eglot lsp
  (with-eval-after-load 'eglot
    (add-to-list 'eglot-server-programs
                 '(nix-mode . ("${pkgs.nil}/bin/nil"))))

  (with-eval-after-load 'nix-mode
    (setq nix-nixfmt-bin "${pkgs.nixfmt-rfc-style}/bin/nixfmt")
    (add-hook 'nix-mode-hook 'eglot-ensure)
    (add-hook 'nix-mode-hook
              (lambda ()
                (add-hook 'before-save-hook #'nix-format-buffer nil t))))

  ;; Line numbers
  (autoload 'display-line-numbers-mode "display-line-numbers" "View line numbers." t)
  (with-eval-after-load 'display-line-numbers
    (setq display-line-numbers-type 'relative))
  (add-hook 'prog-mode-hook 'display-line-numbers-mode)

  ;; Remove trailing whitespace
  (add-hook 'before-save-hook 'delete-trailing-whitespace)
#+end_src

**** Nix Config

Here I define the Emacs config for nix which includes packages.

#+begin_src nix :tangle home/common/emacs.nix :noweb yes
  { pkgs, ... }:

  {
    home.packages = with pkgs; [ nil ];
    programs.emacs = {
      enable = true;
      package = pkgs.emacs30-pgtk;
      extraPackages = epkgs: with epkgs; [
        markdown-mode
        company
        catppuccin-theme
        nix-mode
        magit
      ];
      extraConfig = ''
        <<backup-and-autosave>>

        <<look-and-feel>>

        <<tab-behavior>>

        <<code-editing>>
      '';
    };
  }
#+end_src

*** Kitty

#+begin_src nix :tangle home/common/kitty.nix
  { pkgs, ... }:

  {
    programs.kitty = {
      enable = true;
      shellIntegration.enableZshIntegration = true;

      font = {
        package = (pkgs.nerdfonts.override { fonts = [ "IBMPlexMono" ]; });
        name = "BlexMono Nerd Font";
        size = 10;
      };

      settings = {
        enable_audio_bell = false;
        window_margin_width = 8;
      };

      extraConfig = ''
        background_opacity 0.85
      '';
    };
  }
#+end_src
